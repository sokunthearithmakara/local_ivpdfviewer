define("local_ivpdfviewer/main",["exports","jquery","ivplugin_iframe/main"],(function(_exports,_jquery,_main){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * PDF viewer
   *
   * @module     local_ivpdfviewer/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_main=_interopRequireDefault(_main);class PdfViewer extends _main.default{renderContainer(annotation){(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).addClass("hasiframe"),super.renderContainer(annotation)}async applyContent(annotation){let self=this;const pdfCheck=(annotation,log,getLog)=>{const checkIframe=()=>{const iframe=document.querySelector("#message[data-id='".concat(annotation.id,"'] iframe"));let pdf;try{pdf=iframe.contentWindow.PDFViewerApplication.pdfViewer}catch(e){pdf=null}if(pdf&&pdf.pagesCount>0){window.pdf=pdf;let pageToDisplay=annotation.char1,pages=[];pages=pageToDisplay&&""!==pageToDisplay?pageToDisplay.split(",").map((page=>{let range=page.split("-");return range.length>1?Array.from({length:range[1]-range[0]+1},((_,i)=>i+parseInt(range[0]))):parseInt(page)})).flat():Array.from({length:pdf.pagesCount},((_,i)=>i+1));let pagesToRemove=[];for(let i=1;i<=pdf.pagesCount;i++)pages.includes(i)||pagesToRemove.push(i);const lastPage=Math.max(...pages);if(pdf.eventBus.on("pagesloaded",(function(){pagesToRemove.forEach((page=>{let pageElement=iframe.contentWindow.document.querySelector(".page[data-page-number='".concat(page,"']"));pageElement&&(pageElement.style.height="0",pageElement.style.margin="0",pageElement.style.border="0",(0,_jquery.default)(pageElement).empty());let thumbnailElement=iframe.contentWindow.document.querySelector(".thumbnail[data-page-number='".concat(page,"']"));if(thumbnailElement){thumbnailElement.style.height="0",thumbnailElement.style.margin="0",thumbnailElement.style.border="0",thumbnailElement.style.overflow="hidden";let parent=thumbnailElement.parentElement;parent&&(parent.style.display="none")}}))})),""!=log&&(pdf.currentPageNumber=Number(log)),getLog&&(0,_jquery.default)(document).on("interactionclose interactionrefresh",(async function(e){if(e.detail.annotation.id==annotation.id)try{let page=window.pdf.currentPageNumber;await self.saveLog(annotation,{text1:page,char1:annotation.type},self.userid,!0)}catch(e){window.console.log("Error: ",e)}})),self.isEditMode())return;(1===pdf.pagesCount||1===pdf._pages.length||pages.length<=1)&&!annotation.completed&&"scrolltolastpage"==annotation.completiontracking?self.toggleCompletion(annotation.id,"mark-done","automatic"):pdf.eventBus.on("pagechanging",(function(e){annotation.completed||"scrolltolastpage"!=annotation.completiontracking||e.pageNumber!=lastPage||annotation.completed||(self.toggleCompletion(annotation.id,"mark-done","automatic"),annotation.completed=!0)}))}else requestAnimationFrame(checkIframe)};requestAnimationFrame(checkIframe)};self.cache[annotation.id]&&!self.isEditMode()||(self.cache[annotation.id]=await this.render(annotation,"html"));const data=self.cache[annotation.id];if((0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] .modal-body")).attr("id","content").html(data).fadeIn(300),this.postContentRender(annotation),self.isEditMode())return void pdfCheck(annotation,"",!1);let log="",getLog=!1,adv=JSON.parse(annotation.advanced);adv.savepagebefore&&0!=adv.savepagebefore&&0==annotation.completed&&(getLog=!0),adv.savepageafter&&0!=adv.savepageafter&&1==annotation.completed&&(getLog=!0),getLog&&(log=await self.getLogs(annotation,[self.userid]),log.length>0&&(log=log[0].text1)),pdfCheck(annotation,log,getLog),0==annotation.hascompletion||annotation.completed||"view"!=annotation.completiontracking||this.toggleCompletion(annotation.id,"mark-done","automatic")}}return _exports.default=PdfViewer,_exports.default}));

//# sourceMappingURL=main.min.js.map